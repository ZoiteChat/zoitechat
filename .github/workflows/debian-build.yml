name: Debian Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  debian_build:
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm

    steps:
      - name: Install packaging tooling and build dependencies
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
                git ca-certificates \
                build-essential dpkg-dev debhelper fakeroot \
                pkg-config meson ninja-build \
                gettext iso-codes \
                libcanberra-dev libdbus-glib-1-dev libglib2.0-dev libgtk-3-dev libayatana-appindicator3-dev \
                liblua5.3-dev libpci-dev libperl-dev libssl-dev \
                python3-dev python3-cffi desktop-file-utils
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build Debian packages
        run: |
          set -eux
          dpkg-buildpackage -us -uc -b

      - name: Collect Debian artifacts
        run: |
          set -eux
          mkdir -p artifacts
          cp -v ../*.deb ../*.changes ../*.buildinfo artifacts/

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zoitechat-debian-packages
          path: artifacts/*
