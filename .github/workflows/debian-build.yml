name: Debian Packages

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  debian_packages:
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Debian packaging tooling
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git \
            devscripts equivs fakeroot dpkg-dev

      - name: Install Build-Depends from debian/control
        run: |
          set -eux
          # Creates & installs a dummy package that pulls in Build-Depends
          mk-build-deps -i -r -t "apt-get -y --no-install-recommends" debian/control

      - name: Build .deb packages (no signing)
        run: |
          set -eux
          # Many Debian builds hate running as root. CI loves running as root. Compromise.
          useradd -m builder
          chown -R builder:builder "$GITHUB_WORKSPACE"
          su - builder -s /bin/bash -c "cd '$GITHUB_WORKSPACE' && dpkg-buildpackage -us -uc -b"

      - name: List built artifacts
        run: |
          set -eux
          ls -lah ..

      - uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: |
            ../*.deb
            ../*.buildinfo
            ../*.changes

          ninja -C build install
