name: MSYS2 Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  msys2_build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-python-cffi
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gtk2
            mingw-w64-x86_64-gtk-update-icon-cache
            mingw-w64-x86_64-luajit
            mingw-w64-x86_64-desktop-file-utils
            mingw-w64-x86_64-gettext-tools
            mingw-w64-x86_64-ca-certificates

      - name: Install Inno Setup + IDP
        run: |
          New-Item -Name "deps" -ItemType "Directory"

          Invoke-WebRequest http://files.jrsoftware.org/is/5/innosetup-5.5.9-unicode.exe -OutFile deps\innosetup-unicode.exe
          & deps\innosetup-unicode.exe /VERYSILENT | Out-Null

          Invoke-WebRequest https://github.com/zoitechat/gvsbuild/releases/download/zoitechat-2.17.0/idpsetup-1.5.1.exe -OutFile deps\idpsetup.exe
          & deps\idpsetup.exe /VERYSILENT
        shell: powershell

      - name: Sanity check gettext ITS rules
        run: |
          set -eux
          which msgfmt || true
          msgfmt --version
          ls -la /mingw64/share/gettext-*/its || true

      - name: Configure
        run: |
          set -eux
          rm -rf build
          meson setup build \
            --prefix=/ \
            -Dtext-frontend=true \
            -Ddbus=disabled \
            -Dwith-upd=false \
            -Dwith-perl=false

      - name: Build
        run: ninja -C build

      - name: Test
        run: ninja -C build test

      - name: Stage install tree
        run: |
          set -eux

          rm -rf stage dist
          meson install -C build --destdir stage --strip

          STAGE_DIR="stage"
          [ -d "$STAGE_DIR" ] || STAGE_DIR="build/stage"

          msysroot="$(find "$STAGE_DIR" -maxdepth 12 -type d -name msys64 -print -quit)"
          [ -n "$msysroot" ] || { echo "Couldn't find msys64 under $STAGE_DIR"; find "$STAGE_DIR" -maxdepth 6 -type d -print; exit 1; }

          mkdir -p dist
          cp -a "${msysroot}/." dist/

          # ---- CA bundle for TLS verification (OpenSSL error 20 fix) ----
          if [ -f /mingw64/ssl/cert.pem ]; then
            cp -f /mingw64/ssl/cert.pem dist/cert.pem
          elif [ -f /mingw64/etc/ssl/certs/ca-bundle.crt ]; then
            cp -f /mingw64/etc/ssl/certs/ca-bundle.crt dist/cert.pem
          elif [ -f /etc/ssl/certs/ca-bundle.crt ]; then
            cp -f /etc/ssl/certs/ca-bundle.crt dist/cert.pem
          else
            echo "No CA bundle found in MSYS2. TLS will fail." >&2
            exit 1
          fi

          ls -la dist/cert.pem


          # Your existing extras
          printf "2\n" > dist/portable-mode
          cp -f /mingw64/bin/gspawn-win64-helper*.exe dist/bin/ || true

          # Sanity (fails fast if something is still wrong)
          ls -la dist/bin/zoitechat.exe
          ls -la dist/bin/zoitechat-text.exe || true

          deps_file="dist/.deps.txt"
          : > "${deps_file}"

          collect_deps() {
            local target="$1"
            if [ -f "${target}" ]; then
              ldd "${target}" 2>/dev/null | awk '/=>/ {print $3}' | grep -E '^/mingw64/' >> "${deps_file}" || true
            fi
          }

          collect_deps "dist/bin/zoitechat.exe"
          collect_deps "dist/bin/zoitechat-text.exe"

          if [ -d "dist/lib/zoitechat/plugins" ]; then
            while IFS= read -r -d '' plugin; do
              collect_deps "${plugin}"
            done < <(find dist/lib/zoitechat/plugins -name "*.dll" -print0)
          fi

          sort -u "${deps_file}" | while read -r dep; do
            cp -u "${dep}" dist/bin/
          done
          rm -f "${deps_file}"

      - name: Generate installer script
        run: |
          $env:SOLUTIONDIR = "${{ github.workspace }}\"
          .\win32\version-template.ps1 .\win32\installer\zoitechat-mingw64.iss.tt .\win32\installer\zoitechat-mingw64.iss
        shell: powershell

      - name: Build installer
        run: |
          $repo = "${{ github.workspace }}"
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 5\ISCC.exe"
          & $iscc /DPROJECTDIR="$repo\win32\installer\" /DSRCDIR="$repo\dist" /DOUTPUTDIR="$repo" "$repo\win32\installer\zoitechat-mingw64.iss"
        shell: powershell

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Installer MSYS2
          path: ZoiteChat*.exe

      - name: Upload Build Files
        uses: actions/upload-artifact@v4
        with:
          name: Build Files MSYS2
          path: dist
